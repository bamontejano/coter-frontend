<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coter - Interfaz Terapeuta</title>
    <style>
        :root {
            --primary-color: #e74c3c; /* Rojo Terapeuta */
            --secondary-color: #c0392b; 
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --text-color: #333;
        }
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--light-color); color: var(--text-color); }
        .app-container { max-width: 900px; margin: 40px auto; background-color: white; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); overflow: hidden; min-height: 600px; }
        .header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 20px; }
        .patient-card { background-color: #fceeee; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .patient-card button { background-color: var(--dark-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .patient-card button:hover { background-color: #34495e; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; color: var(--secondary-color); }
        .logout-button { background: none; border: 1px solid white; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        
        /* Estilos de la Vista de Detalle */
        #patient-details-view { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #patient-details-view h3 { border-bottom: 1px solid #eee; padding-bottom: 5px; color: var(--dark-color); }
        
        /* Estilos para Check-ins */
        .checkin-card { background-color: #f7f7f7; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--success-color); }
        .checkin-card .score { font-weight: bold; color: var(--success-color); margin-right: 10px; }

        /* Estilos para Metas */
        .goal-card-therapist { background-color: #fff9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #3498db; /* Azul */ }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-left: 10px; }
        .status-PENDING { background-color: #f1c40f; color: var(--dark-color); }
        .status-IN_PROGRESS { background-color: #3498db; color: white; }
        .status-COMPLETED { background-color: var(--success-color); color: white; }
        .status-ARCHIVED { background-color: var(--dark-color); color: white; }

        /* Estilos del Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; 
            margin: 10% auto; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 80%; 
            max-width: 600px; 
            border-radius: 8px;
        }
        .close-button {
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer;
        }
        .modal-form input[type="text"], .modal-form input[type="number"], .modal-form input[type="date"], .modal-form textarea {
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <h1>Coter - Interfaz Terapeuta</h1>
        <button class="logout-button" onclick="logout()">Cerrar Sesi√≥n</button>
    </header>

    <div class="content">

        <section style="margin-bottom: 30px;">
            <h2>üë§ Asignar Nuevo Paciente</h2>
            <div id="assign-message" style="margin-bottom: 10px;"></div>
            <form id="assign-form" onsubmit="event.preventDefault(); assignPatient(event.target)">
                <input type="email" id="patientEmail" placeholder="Email del Paciente" required style="width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <button type="submit" style="width: 25%; padding: 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; float: right;">Asignar</button>
            </form>
        </section>

        <div id="patients-list-view">
            <h2>üìã Mis Pacientes Asignados</h2>
            <div id="patients-list">Cargando pacientes...</div>
        </div>

        <div id="patient-details-view" style="display: none;">
            <button onclick="showPatientListView()" style="margin-bottom: 15px; padding: 8px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Volver a la Lista</button>
            <h2 id="patient-detail-name">Detalles del Paciente</h2>

            <section>
                <h3>üìà Check-ins Recientes</h3>
                <div id="checkins-list">No hay check-ins recientes.</div>
            </section>

            <section style="margin-top: 20px; position: relative;">
                <h3>üéØ Metas Asignadas</h3>
                <button id="create-goal-button" style="position: absolute; top: 15px; right: 0; padding: 8px 15px; background-color: var(--dark-color); color: white; border: none; border-radius: 4px; cursor: pointer;">+ Crear Meta</button>
                <div id="goals-for-patient-list" style="margin-top: 10px;">Cargando metas...</div>
            </section>
        </div>

    </div>
</div>

<div id="goal-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" class="close-button">&times;</span>
        <h2>Crear Nueva Meta</h2>
        <div id="goal-form-message" style="margin-bottom: 10px;"></div>
        
        <form id="create-goal-form" onsubmit="event.preventDefault(); handleCreateGoal(event)" class="modal-form">
            
            <div style="margin-bottom: 15px;">
                <label for="goalTitle" style="display: block; font-weight: bold;">T√≠tulo:</label>
                <input type="text" id="goalTitle" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalDescription" style="display: block; font-weight: bold;">Descripci√≥n (Opcional):</label>
                <textarea id="goalDescription" rows="3"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalDueDate" style="display: block; font-weight: bold;">Fecha L√≠mite:</label>
                <input type="date" id="goalDueDate" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalMetric" style="display: block; font-weight: bold;">M√©trica (Ej: veces por semana):</label>
                <input type="text" id="goalMetric">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalTarget" style="display: block; font-weight: bold;">Objetivo (Ej: 3):</label>
                <input type="number" id="goalTarget">
            </div>
            
            <button type="submit" style="padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar Meta</button>
        </form>
    </div>
</div>


<script>
    // ‚ö†Ô∏è Reemplaza con la URL base de tu backend de Render (sin el /api)
    const API_BASE_URL = 'URL_DE_TU_RENDER_BACKEND/api'; 
    let currentPatientId = null; // Almacena el ID del paciente actualmente visualizado

    // --- FUNCIONES DE AUTENTICACI√ìN ---

    function getToken() {
        return localStorage.getItem('token');
    }
    
    function checkAuthentication() {
        const token = getToken();
        const role = localStorage.getItem('userRole');
        
        if (!token || role !== 'THERAPIST') {
            alert('Acceso no autorizado. Ser√°s redirigido al login.');
            window.location.href = 'index.html';
            return;
        }
        
        loadPatients();
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
        };
    }
    
    function showAlert(id, message, isError = false) {
        const alertElement = document.getElementById(id);
        
        // Si el elemento no existe (ej: estamos en el modal), lo creamos temporalmente
        if (!alertElement) return;

        alertElement.textContent = message;
        alertElement.style.display = 'block';
        alertElement.style.padding = '10px';
        alertElement.style.borderRadius = '4px';

        if (isError) {
            alertElement.style.backgroundColor = '#fdd';
            alertElement.style.color = 'var(--primary-color)';
        } else {
            alertElement.style.backgroundColor = '#dfd';
            alertElement.style.color = 'var(--success-color)';
        }

        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 5000);
    }

    // --- L√ìGICA DE PACIENTES Y ASIGNACI√ìN ---

    async function loadPatients() {
        const list = document.getElementById('patients-list');
        list.innerHTML = 'Cargando...';
        showPatientListView(); // Asegura que la vista de lista est√© visible

        try {
            const response = await fetch(`${API_BASE_URL}/therapist/patients`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            const patients = await response.json();
            
            if (!response.ok) {
                throw new Error(patients.message || 'Error al cargar pacientes.');
            }
            
            if (patients.length === 0) {
                list.innerHTML = '<p>A√∫n no tienes pacientes asignados.</p>';
                return;
            }

            list.innerHTML = patients.map(p => `
                <div class="patient-card">
                    <div>
                        <strong>${p.firstName || 'Sin Nombre'} ${p.lastName || ''}</strong>
                        <p>Email: ${p.email}</p>
                    </div>
                    <button onclick="viewPatientDetails('${p.id}')">Ver Detalles</button>
                </div>
            `).join('');

        } catch (error) {
            list.innerHTML = `<p style="color: var(--primary-color);">Error al cargar pacientes: ${error.message}</p>`;
        }
    }

    async function assignPatient(form) {
        const email = document.getElementById('patientEmail').value;
        const messageDiv = document.getElementById('assign-message');
        messageDiv.innerHTML = '';
        
        try {
            const response = await fetch(`${API_BASE_URL}/therapist/assign`, {
                method: 'PATCH',
                headers: getAuthHeaders(),
                body: JSON.stringify({ patientEmail: email })
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Error al asignar paciente.');
            }

            showAlert('assign-message', result.message, false);
            form.reset();
            loadPatients(); 

        } catch (error) {
            showAlert('assign-message', error.message, true);
        }
    }

    // --- L√ìGICA DE VISTAS Y MODAL ---

    /** Muestra la lista de pacientes y oculta los detalles. */
    function showPatientListView() {
        document.getElementById('patients-list-view').style.display = 'block';
        document.getElementById('patient-details-view').style.display = 'none';
        currentPatientId = null; 
    }

    /** Abre el modal de creaci√≥n de meta */
    function openCreateGoalModal(patientId) {
        if (!patientId) {
            alert("Error: ID de paciente no definido.");
            return;
        }
        currentPatientId = patientId; // Usamos la variable global
        document.getElementById('goal-modal').style.display = 'block';
        document.getElementById('create-goal-form').reset(); 
        document.getElementById('goal-form-message').style.display = 'none';
    }

    /** Cierra el modal */
    function closeModal() {
        document.getElementById('goal-modal').style.display = 'none';
        // currentPatientId se mantiene porque el usuario puede querer seguir viendo detalles.
    }

    /** Obtiene y muestra los detalles completos del paciente (Check-ins y Metas). */
    async function viewPatientDetails(patientId) {
        document.getElementById('patients-list-view').style.display = 'none';
        document.getElementById('patient-details-view').style.display = 'block';

        const nameHeader = document.getElementById('patient-detail-name');
        const checkinsList = document.getElementById('checkins-list');
        const goalsList = document.getElementById('goals-for-patient-list');
        const createGoalButton = document.getElementById('create-goal-button');

        nameHeader.textContent = 'Cargando...';
        checkinsList.innerHTML = 'Cargando check-ins...';
        goalsList.innerHTML = 'Cargando metas...';
        
        currentPatientId = patientId; 
        
        // ‚ö†Ô∏è Conectamos el bot√≥n de crear meta a la funci√≥n del modal
        createGoalButton.setAttribute('onclick', `openCreateGoalModal('${patientId}')`);

        try {
            const response = await fetch(`${API_BASE_URL}/therapist/patient/${patientId}`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            const patient = await response.json();

            if (!response.ok) {
                throw new Error(patient.message || 'Error al obtener detalles del paciente.');
            }

            // 1. Mostrar nombre
            nameHeader.textContent = `${patient.firstName} ${patient.lastName || ''} (${patient.email})`;

            // 2. Mostrar Check-ins
            if (patient.checkins && patient.checkins.length > 0) {
                checkinsList.innerHTML = patient.checkins.map(c => `
                    <div class="checkin-card">
                        <span class="score">√Ånimo: ${c.moodScore}/5</span>
                        <small>(${new Date(c.date).toLocaleDateString()} ${new Date(c.date).toLocaleTimeString()})</small>
                        <p>Notas: ${c.notes || 'N/A'}</p>
                    </div>
                `).join('');
            } else {
                checkinsList.innerHTML = '<p>El paciente a√∫n no ha registrado check-ins.</p>';
            }

            // 3. Mostrar Metas
            if (patient.assignedGoals && patient.assignedGoals.length > 0) {
                const statusClass = (status) => `status-badge status-${status}`;

                goalsList.innerHTML = patient.assignedGoals.map(g => `
                    <div class="goal-card-therapist">
                        <strong>${g.title}</strong>
                        <span class="${statusClass(g.status)}" style="float: right;">${g.status.replace('_', ' ')}</span>
                        <p>${g.description || 'Sin descripci√≥n.'}</p>
                        <p><small>L√≠mite: ${new Date(g.dueDate).toLocaleDateString()}</small></p>
                        <p><small>M√©trica/Objetivo: ${g.metric || 'N/A'} / ${g.target || 'N/A'}</small></p>
                        <button onclick="alert('Funcionalidad de edici√≥n PENDIENTE para la meta ${g.id}')" style="margin-top: 10px; padding: 5px 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Editar</button>
                    </div>
                `).join('');
            } else {
                goalsList.innerHTML = '<p>A√∫n no hay metas asignadas a este paciente.</p>';
            }

        } catch (error) {
            document.getElementById('patient-details-view').innerHTML = `<p style="color: var(--primary-color);">Error: ${error.message}. Por favor, vuelve a la lista.</p>
                <button onclick="showPatientListView()" style="margin-top: 15px; padding: 8px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Volver a la Lista</button>`;
        }
    }

    /** Maneja el env√≠o del formulario de Creaci√≥n de Meta */
    async function handleCreateGoal(event) {
        event.preventDefault();
        
        if (!currentPatientId) {
            showAlert('goal-form-message', 'Error interno: ID del paciente no encontrado.', true);
            return;
        }

        const title = document.getElementById('goalTitle').value;
        const description = document.getElementById('goalDescription').value;
        const dueDate = document.getElementById('goalDueDate').value;
        const metric = document.getElementById('goalMetric').value;
        const target = document.getElementById('goalTarget').value;
        
        if (!title || !dueDate) {
            showAlert('goal-form-message', 'El T√≠tulo y la Fecha L√≠mite son obligatorios.', true);
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/therapist/goals`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    patientId: currentPatientId,
                    title: title,
                    description: description,
                    dueDate: dueDate,
                    metric: metric,
                    target: target 
                })
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Error al crear la meta.');
            }

            showAlert('goal-form-message', 'Meta creada exitosamente!', false);
            
            setTimeout(() => {
                closeModal(); // Cerrar modal al √©xito despu√©s de un breve tiempo
                viewPatientDetails(currentPatientId); // Recargar los detalles para mostrar la nueva meta
            }, 1000); 

        } catch (error) {
            showAlert('goal-form-message', error.message, true);
        }
    }

    window.onload = checkAuthentication;
</script>
</body>
</html>