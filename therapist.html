<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coter - Interfaz Terapeuta</title>
    <style>
        :root {
            --primary-color: #e74c3c; /* Rojo Terapeuta */
            --secondary-color: #c0392b; 
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --text-color: #333;
        }
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--light-color); color: var(--text-color); }
        .app-container { max-width: 900px; margin: 40px auto; background-color: white; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); overflow: hidden; min-height: 600px; }
        .header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 20px; }
        .patient-card { background-color: #fceeee; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .patient-card button { background-color: var(--dark-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .patient-card button:hover { background-color: #34495e; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; color: var(--secondary-color); }
        .logout-button { background: none; border: 1px solid white; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        
        /* Estilos de la Vista de Detalle */
        #patient-details-view { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #patient-details-view h3 { border-bottom: 1px solid #eee; padding-bottom: 5px; color: var(--dark-color); }
        
        /* Estilos para Check-ins */
        .checkin-card { background-color: #f7f7f7; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--success-color); }
        .checkin-card .score { font-weight: bold; color: var(--success-color); margin-right: 10px; }

        /* Estilos para Metas */
        .goal-card-therapist { background-color: #fff9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #3498db; /* Azul */ }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-left: 10px; }
        .status-PENDING { background-color: #f1c40f; color: var(--dark-color); }
        .status-IN_PROGRESS { background-color: #3498db; color: white; }
        .status-COMPLETED { background-color: var(--success-color); color: white; }
        .status-ARCHIVED { background-color: var(--dark-color); color: white; }

        /* Estilos del Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; 
            margin: 10% auto; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 80%; 
            max-width: 600px; 
            border-radius: 8px;
        }
        .close-button {
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer;
        }
        .modal-form input[type="text"], .modal-form input[type="number"], .modal-form input[type="date"], .modal-form textarea, .modal-form select {
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <h1>Coter - Interfaz Terapeuta</h1>
        <button class="logout-button" onclick="logout()">Cerrar Sesi√≥n</button>
    </header>

    <div class="content">

        <section style="margin-bottom: 30px;">
            <h2>üë§ Asignar Nuevo Paciente</h2>
            <div id="assign-message" style="margin-bottom: 10px;"></div>
            <form id="assign-form" onsubmit="event.preventDefault(); assignPatient(event.target)">
                <input type="email" id="patientEmail" placeholder="Email del Paciente" required style="width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <button type="submit" style="width: 25%; padding: 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; float: right;">Asignar</button>
            </form>
        </section>

        <div id="patients-list-view">
            <h2>üìã Mis Pacientes Asignados</h2>
            <div id="patients-list">Cargando pacientes...</div>
        </div>

        <div id="patient-details-view" style="display: none;">
            <button onclick="showPatientListView()" style="margin-bottom: 15px; padding: 8px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Volver a la Lista</button>
            <h2 id="patient-detail-name">Detalles del Paciente</h2>

            <section>
                <h3>üìà Check-ins Recientes</h3>
                <div id="checkins-list">No hay check-ins recientes.</div>
            </section>

            <section style="margin-top: 20px; position: relative;">
                <h3>üéØ Metas Asignadas</h3>
                <button id="create-goal-button" style="position: absolute; top: 15px; right: 0; padding: 8px 15px; background-color: var(--dark-color); color: white; border: none; border-radius: 4px; cursor: pointer;">+ Crear Meta</button>
                <div id="goals-for-patient-list" style="margin-top: 10px;">Cargando metas...</div>
            </section>
        </div>

    </div>
</div>

<div id="goal-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" class="close-button">&times;</span>
        <h2 id="modal-title">Crear Nueva Meta</h2>
        <div id="goal-form-message" style="margin-bottom: 10px;"></div>
        
        <form id="create-goal-form" onsubmit="event.preventDefault(); handleCreateGoal(event)" class="modal-form">
            
            <div style="margin-bottom: 15px;">
                <label for="goalTitle" style="display: block; font-weight: bold;">T√≠tulo:</label>
                <input type="text" id="goalTitle" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalDescription" style="display: block; font-weight: bold;">Descripci√≥n (Opcional):</label>
                <textarea id="goalDescription" rows="3"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalDueDate" style="display: block; font-weight: bold;">Fecha L√≠mite:</label>
                <input type="date" id="goalDueDate" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalMetric" style="display: block; font-weight: bold;">M√©trica (Ej: veces por semana):</label>
                <input type="text" id="goalMetric">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalTarget" style="display: block; font-weight: bold;">Objetivo (Ej: 3):</label>
                <input type="number" id="goalTarget">
            </div>

            <div id="status-field" style="margin-bottom: 15px; display: none;"> 
                <label for="goalStatus" style="display: block; font-weight: bold;">Estado de la Meta:</label>
                <select id="goalStatus">
                    <option value="PENDING">PENDIENTE</option>
                    <option value="IN_PROGRESS">EN PROGRESO</option>
                    <option value="COMPLETED">COMPLETADA</option>
                    <option value="ARCHIVED">ARCHIVADA</option>
                </select>
            </div>
            
            <button type="submit" style="padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar Meta</button>
        </form>
    </div>
</div>


<script>
    // ‚ö†Ô∏è REEMPLAZA ESTA URL CON LA DIRECCI√ìN REAL DE TU BACKEND DE RENDER
    const API_BASE_URL = 'https://coter-backend.onrender.com/api'; 
    let currentPatientId = null; // ID del paciente actualmente visualizado
    let currentGoalId = null;    // ID de la meta que se est√° editando (null si es creaci√≥n)

    // --- Funciones de Utilidad y Auth ---

    function getToken() {
        return localStorage.getItem('token');
    }
    
    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
        };
    }
    
    function showAlert(id, message, isError = false) {
        const alertElement = document.getElementById(id);
        if (!alertElement) return;

        alertElement.textContent = message;
        alertElement.style.display = 'block';
        alertElement.style.padding = '10px';
        alertElement.style.borderRadius = '4px';

        if (isError) {
            alertElement.style.backgroundColor = '#fdd';
            alertElement.style.color = 'var(--primary-color)';
        } else {
            alertElement.style.backgroundColor = '#dfd';
            alertElement.style.color = 'var(--success-color)';
        }

        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 8000);
    }

    /**
     * Maneja respuestas con error (no-JSON) y las formatea para un mensaje de error legible.
     */
    async function handleResponseError(response) {
        let errorDetail = `Error ${response.status} (${response.statusText}): El servidor no respondi√≥ con JSON v√°lido.`;
        
        try {
            const errorJson = await response.json();
            errorDetail = errorJson.message || 'Error del servidor sin mensaje espec√≠fico.';
        } catch (e) {
            const errorText = await response.text();
            errorDetail = errorText.substring(0, 200);
        }
        
        throw new Error(`¬°FALLO EN LA CONEXI√ìN! Status ${response.status}. Detalle: ${errorDetail}`);
    }

    function checkAuthentication() {
        const token = getToken();
        const role = localStorage.getItem('userRole');
        
        if (!token || role !== 'THERAPIST') {
            alert('Acceso no autorizado. Ser√°s redirigido al login.');
            window.location.href = 'index.html';
            return;
        }
        
        loadPatients();
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    function showPatientListView() {
        document.getElementById('patients-list-view').style.display = 'block';
        document.getElementById('patient-details-view').style.display = 'none';
        currentPatientId = null; 
    }

    // --- L√ìGICA DEL MODAL ---

    /** Abre el modal para CREAR una meta */
    function openCreateGoalModal(patientId) {
        if (!patientId) return alert("Error: ID de paciente no definido.");
        currentPatientId = patientId;
        currentGoalId = null; // Modo Creaci√≥n
        
        document.getElementById('modal-title').textContent = 'Crear Nueva Meta';
        document.getElementById('status-field').style.display = 'none'; // Ocultar estado
        
        document.getElementById('create-goal-form').reset();
        document.getElementById('goal-modal').style.display = 'block';
        document.getElementById('goal-form-message').style.display = 'none';
    }

    /** Abre el modal para EDITAR una meta */
    function openEditGoalModal(goalId, title, description, dueDate, metric, target, status) {
        currentGoalId = goalId; // Modo Edici√≥n
        
        document.getElementById('modal-title').textContent = 'Editar Meta';
        document.getElementById('status-field').style.display = 'block'; // Mostrar estado
        
        // Rellenar formulario
        document.getElementById('goalTitle').value = title;
        document.getElementById('goalDescription').value = description;
        document.getElementById('goalDueDate').value = dueDate;
        document.getElementById('goalMetric').value = metric;
        document.getElementById('goalTarget').value = target;
        document.getElementById('goalStatus').value = status;
        
        document.getElementById('goal-modal').style.display = 'block';
        document.getElementById('goal-form-message').style.display = 'none';
    }

    /** Cierra el modal */
    function closeModal() {
        document.getElementById('goal-modal').style.display = 'none';
        currentGoalId = null; // Limpiar el ID de la meta editada al cerrar
    }

    // --- L√ìGICA DE DATOS Y API ---

    async function loadPatients() {
        const list = document.getElementById('patients-list');
        list.innerHTML = 'Cargando...';
        showPatientListView();

        try {
            const response = await fetch(`${API_BASE_URL}/therapist/patients`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const patients = await response.json();
            
            if (patients.length === 0) {
                list.innerHTML = '<p>A√∫n no tienes pacientes asignados.</p>';
                return;
            }

            list.innerHTML = patients.map(p => `
                <div class="patient-card">
                    <div>
                        <strong>${p.firstName || 'Sin Nombre'} ${p.lastName || ''}</strong>
                        <p>Email: ${p.email}</p>
                    </div>
                    <button onclick="viewPatientDetails('${p.id}')">Ver Detalles</button>
                </div>
            `).join('');

        } catch (error) {
            list.innerHTML = `<p style="color: var(--primary-color);">Error al cargar pacientes: ${error.message}</p>`;
        }
    }

    async function viewPatientDetails(patientId) {
        document.getElementById('patients-list-view').style.display = 'none';
        document.getElementById('patient-details-view').style.display = 'block';

        const nameHeader = document.getElementById('patient-detail-name');
        const checkinsList = document.getElementById('checkins-list');
        const goalsList = document.getElementById('goals-for-patient-list');
        const createGoalButton = document.getElementById('create-goal-button');

        nameHeader.textContent = 'Cargando...';
        checkinsList.innerHTML = 'Cargando check-ins...';
        goalsList.innerHTML = 'Cargando metas...';
        
        currentPatientId = patientId; 
        
        // Conectar el bot√≥n de crear meta a la funci√≥n de apertura de modal
        createGoalButton.setAttribute('onclick', `openCreateGoalModal('${patientId}')`);

        try {
            const response = await fetch(`${API_BASE_URL}/therapist/patient/${patientId}`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const patient = await response.json();

            // 1. Mostrar nombre
            nameHeader.textContent = `${patient.firstName} ${patient.lastName || ''} (${patient.email})`;

            // 2. Mostrar Check-ins
            if (patient.checkins && patient.checkins.length > 0) {
                checkinsList.innerHTML = patient.checkins.map(c => `
                    <div class="checkin-card">
                        <span class="score">√Ånimo: ${c.moodScore}/5</span>
                        <small>(${new Date(c.date).toLocaleDateString()} ${new Date(c.date).toLocaleTimeString()})</small>
                        <p>Notas: ${c.notes || 'N/A'}</p>
                    </div>
                `).join('');
            } else {
                checkinsList.innerHTML = '<p>El paciente a√∫n no ha registrado check-ins.</p>';
            }

            // 3. Mostrar Metas
            if (patient.assignedGoals && patient.assignedGoals.length > 0) {
                const statusClass = (status) => `status-badge status-${status}`;

                goalsList.innerHTML = patient.assignedGoals.map(g => `
                    <div class="goal-card-therapist">
                        <strong>${g.title}</strong>
                        <span class="${statusClass(g.status)}" style="float: right;">${g.status.replace('_', ' ')}</span>
                        <p>${g.description || 'Sin descripci√≥n.'}</p>
                        <p><small>L√≠mite: ${new Date(g.dueDate).toLocaleDateString()}</small></p>
                        <p><small>M√©trica/Objetivo: ${g.metric || 'N/A'} / ${g.target || 'N/A'}</small></p>
                        <button onclick="openEditGoalModal(
                            '${g.id}', 
                            '${g.title.replace(/'/g, "\\'")}', 
                            '${g.description ? g.description.replace(/'/g, "\\'") : ''}', 
                            '${g.dueDate.substring(0, 10)}', 
                            '${g.metric || ''}', 
                            '${g.target || ''}', 
                            '${g.status}'
                        )" style="margin-top: 10px; padding: 5px 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Editar</button>
                    </div>
                `).join('');
            } else {
                goalsList.innerHTML = '<p>A√∫n no hay metas asignadas a este paciente.</p>';
            }

        } catch (error) {
            document.getElementById('patient-details-view').innerHTML = `<p style="color: var(--primary-color);">Error al cargar detalles: ${error.message}</p>
                <button onclick="showPatientListView()" style="margin-top: 15px; padding: 8px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Volver a la Lista</button>`;
        }
    }

    /** * Maneja la creaci√≥n (POST) o edici√≥n (PATCH) de metas.
     */
    async function handleCreateGoal(event) {
        event.preventDefault();
        
        const isEditing = currentGoalId !== null;
        const url = isEditing 
            ? `${API_BASE_URL}/therapist/goals/${currentGoalId}` 
            : `${API_BASE_URL}/therapist/goals`;
        const method = isEditing ? 'PATCH' : 'POST';

        const title = document.getElementById('goalTitle').value;
        const description = document.getElementById('goalDescription').value;
        const dueDate = document.getElementById('goalDueDate').value;
        const metric = document.getElementById('goalMetric').value;
        const target = document.getElementById('goalTarget').value;
        
        // Solo incluir el status si estamos editando
        const status = isEditing ? document.getElementById('goalStatus').value : 'PENDING';

        const dataToSend = {
            title: title,
            description: description,
            dueDate: dueDate,
            metric: metric,
            target: target,
            status: status 
        };
        
        // En modo creaci√≥n, necesitamos el patientId
        if (!isEditing) {
            if (!currentPatientId) {
                showAlert('goal-form-message', 'Error: ID de paciente no encontrado.', true);
                return;
            }
            dataToSend.patientId = currentPatientId;
        }
        
        // Limpiar datos vac√≠os para PATCH para no sobreescribir con valores nulos
        if (isEditing) {
            Object.keys(dataToSend).forEach(key => {
                if (dataToSend[key] === null || dataToSend[key] === '' || dataToSend[key] === undefined) {
                    delete dataToSend[key];
                }
            });
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(dataToSend)
            });

            if (!response.ok) {
                await handleResponseError(response);
            }
            
            const result = await response.json();
            showAlert('goal-form-message', isEditing ? 'Meta actualizada exitosamente!' : 'Meta creada exitosamente!', false);
            
            setTimeout(() => {
                closeModal(); 
                // Usamos currentPatientId para recargar la vista del paciente actual
                viewPatientDetails(currentPatientId); 
            }, 1000); 

        } catch (error) {
            showAlert('goal-form-message', error.message, true);
        }
    }

    // Incluye la funci√≥n assignPatient si todav√≠a la necesitas
    async function assignPatient(form) {
        const email = document.getElementById('patientEmail').value;
        const messageDiv = document.getElementById('assign-message');
        messageDiv.innerHTML = '';
        
        try {
            const response = await fetch(`${API_BASE_URL}/therapist/assign`, {
                method: 'PATCH',
                headers: getAuthHeaders(),
                body: JSON.stringify({ patientEmail: email })
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const result = await response.json();
            
            showAlert('assign-message', result.message, false);
            form.reset();
            loadPatients();

        } catch (error) {
            showAlert('assign-message', error.message, true);
        }
    }


    window.onload = checkAuthentication;
</script>
</body>
</html>