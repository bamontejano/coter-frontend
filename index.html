<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coter - Plataforma Terap√©utica</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Estilos CSS simplificados para la estructura */
        :root {
            --primary-color: #3498db; /* Azul Paciente */
            --secondary-color: #e74c3c; /* Rojo Terapeuta */
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --text-color: #333;
        }
        body { font-family: sans-serif; margin: 0; background-color: var(--light-color); color: var(--text-color); }
        .app-container { max-width: 450px; margin: 40px auto; background-color: white; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); overflow: hidden; min-height: 600px; padding: 20px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab-button { flex-grow: 1; padding: 10px; background-color: #eee; border: none; cursor: pointer; border-radius: 6px 6px 0 0; }
        .auth-tab-button.active { background-color: var(--primary-color); color: white; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .auth-button { width: 100%; padding: 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .header { background-color: var(--primary-color); color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .logout-button { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .nav-bar { display: flex; justify-content: space-around; background-color: var(--dark-color); margin-top: 10px; padding: 5px 0; border-radius: 4px; }
        .nav-bar button { background: none; border: none; color: white; padding: 10px 15px; cursor: pointer; transition: background-color 0.3s; }
        .nav-bar button.active { background-color: var(--primary-color); border-radius: 4px; }

        /* Estilos del Dashboard */
        .checkin-form { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .goal-card { background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary-color); }
        .goal-card strong { color: var(--dark-color); }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; margin-left: 10px; }
        .status-PENDING { background-color: #f39c12; color: white; }
        .status-IN_PROGRESS { background-color: #3498db; color: white; }
        .status-COMPLETED { background-color: var(--success-color); color: white; }
        .status-ARCHIVED { background-color: var(--dark-color); color: white; }
        
        /* NUEVO: Estilos para el indicador de progreso */
        .progress-bar-container {
            background-color: #ddd;
            border-radius: 4px;
            margin-top: 8px;
            height: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            transition: width 0.4s ease-in-out;
            background-color: var(--success-color); 
        }
        /* Asignaci√≥n de anchos y colores de barra de progreso basados en el estado */
        .status-PENDING .progress-bar { width: 10%; background-color: var(--warning-color); }
        .status-IN_PROGRESS .progress-bar { width: 50%; background-color: var(--primary-color); }
        .status-COMPLETED .progress-bar { width: 100%; background-color: var(--success-color); }
        .status-ARCHIVED .progress-bar { width: 100%; background-color: var(--dark-color); }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="authScreen">
        <h2>Coter - Acceso</h2>
        <div class="auth-tabs">
            <button class="auth-tab-button active" onclick="showAuthRole('PATIENT')">Paciente</button>
            <button class="auth-tab-button" onclick="showAuthRole('THERAPIST')">Terapeuta</button>
        </div>
        
        <div id="auth-message" style="margin-bottom: 10px;"></div>

        <form id="auth-form" onsubmit="event.preventDefault(); handleAuth()">
            <div class="form-group">
                <label for="authEmail">Email:</label>
                <input type="email" id="authEmail" required>
            </div>
            <div class="form-group">
                <label for="authPassword">Contrase√±a:</label>
                <input type="password" id="authPassword" required>
            </div>
            
            <div id="register-fields">
                <div class="form-group">
                    <label for="authFirstName">Nombre:</label>
                    <input type="text" id="authFirstName">
                </div>
                <div class="form-group">
                    <label for="authLastName">Apellido:</label>
                    <input type="text" id="authLastName">
                </div>
            </div>

            <button type="submit" id="authSubmitButton" class="auth-button">Iniciar Sesi√≥n</button>
            <p style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="toggleAuthMode(event)" id="toggleAuthLink">¬øNo tienes cuenta? Reg√≠strate</a>
            </p>
        </form>
    </div>
    
    <div id="patientAppInterface" style="display: none;">
        <header class="header">
            <h3 id="patientHeaderGreeting">Hola!</h3>
            <button class="logout-button" onclick="logoutUser()">Cerrar Sesi√≥n</button>
        </header>

        <nav class="nav-bar">
            <button id="nav-dashboard" onclick="showScreen('dashboard')" class="active">Dashboard</button>
            <button id="nav-checkin" onclick="showScreen('checkin')">Check-in</button>
            <button id="nav-goals" onclick="showScreen('goals')">Mis Metas</button>
        </nav>

        <div style="padding: 20px;">
            
            <div id="dashboard-screen" class="app-screen">
                <h2>üëã Dashboard Principal</h2>
                
                <section style="margin-top: 30px;">
                    <h3>üìä Historial de √Ånimo (Check-ins)</h3>
                    <div style="background: #f7f7f7; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <canvas id="moodChart" style="max-height: 250px;"></canvas>
                        <p id="chart-message" style="text-align: center; color: #888; font-size: 0.9em;">Cargando historial...</p>
                    </div>
                </section>
            </div>

            <div id="checkin-screen" class="app-screen" style="display: none;">
                <div class="checkin-form">
                    <h2>üìù Registro R√°pido</h2>
                    <div id="checkin-message" style="margin-bottom: 10px;"></div>
                    <form id="checkin-form" onsubmit="event.preventDefault(); submitCheckin()">
                        <div class="form-group">
                            <label for="moodScore">Nivel de √Ånimo (1-5):</label>
                            <input type="range" id="moodScore" min="1" max="5" value="3" oninput="document.getElementById('moodValue').innerText = this.value">
                            <p style="text-align: center;">Valor: <span id="moodValue">3</span></p>
                        </div>
                        <div class="form-group">
                            <label for="checkinNotes">Notas (Opcional):</label>
                            <textarea id="checkinNotes" rows="3"></textarea>
                        </div>
                        <button type="submit" class="auth-button" style="background-color: var(--success-color);">Guardar Check-in</button>
                    </form>
                </div>
            </div>

            <div id="goals-screen" class="app-screen" style="display: none;">
                <h2>üéØ Mis Metas Asignadas</h2>
                
                <div style="margin-bottom: 15px;">
                    <label for="patientGoalFilter" style="font-weight: bold;">Filtrar:</label>
                    <select id="patientGoalFilter" onchange="filterPatientGoals()" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="ALL">Todas las Metas</option>
                        <option value="PENDING">Pendientes</option>
                        <option value="IN_PROGRESS">En Progreso</option>
                        <option value="COMPLETED">Completadas</option>
                        <option value="ARCHIVED">Archivadas</option>
                    </select>
                </div>

                <div id="goals-list">Cargando metas...</div>
            </div>

        </div>
    </div>
</div>

<script>
    // ‚ö†Ô∏è REEMPLAZA ESTA URL CON LA DIRECCI√ìN REAL DE TU BACKEND DE RENDER
    const API_BASE_URL = 'URL_DE_TU_RENDER_BACKEND/api';
    let currentAuthRole = 'PATIENT'; 
    let isRegisterMode = false;
    let patientId = null; 
    let patientCheckinsCache = []; // Cach√© para los check-ins
    let patientGoalsCache = [];   // NUEVA: Cach√© para las metas

    // --- Funciones de Utilidad y Auth ---

    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        };
    }

    function logoutUser() {
        localStorage.clear();
        window.location.href = 'index.html'; 
    }

    function showAlert(id, message, isError = false) {
        const alertElement = document.getElementById(id);
        alertElement.textContent = message;
        alertElement.style.display = 'block';
        alertElement.style.padding = '10px';
        alertElement.style.borderRadius = '4px';

        if (isError) {
            alertElement.style.backgroundColor = '#fdd';
            alertElement.style.color = 'var(--secondary-color)';
        } else {
            alertElement.style.backgroundColor = '#dfd';
            alertElement.style.color = 'var(--success-color)';
        }

        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 5000);
    }
    
    async function handleResponseError(response) {
        let errorDetail = `Error ${response.status} (${response.statusText}): El servidor no respondi√≥ con JSON v√°lido.`;
        
        try {
            const errorJson = await response.json();
            errorDetail = errorJson.message || 'Error del servidor sin mensaje espec√≠fico.';
        } catch (e) {
            const errorText = await response.text();
            errorDetail = errorText.substring(0, 200);
        }
        
        throw new Error(`¬°FALLO EN LA CONEXI√ìN! Status ${response.status}. Detalle: ${errorDetail}`);
    }


    function showAuthRole(role) {
        currentAuthRole = role;
        const tabs = document.querySelectorAll('.auth-tab-button');
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.textContent.toLowerCase().includes(role.toLowerCase()));
        });
        
        const primaryColor = role === 'PATIENT' ? '#3498db' : '#e74c3c';
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.getElementById('authSubmitButton').style.backgroundColor = primaryColor;
    }

    function toggleAuthMode(event) {
        event.preventDefault();
        isRegisterMode = !isRegisterMode;
        
        const registerFields = document.getElementById('register-fields');
        const toggleLink = document.getElementById('toggleAuthLink');
        const submitButton = document.getElementById('authSubmitButton');
        
        if (isRegisterMode) {
            registerFields.style.display = 'block';
            submitButton.textContent = 'Registrarse';
            toggleLink.textContent = '¬øYa tienes cuenta? Inicia Sesi√≥n';
        } else {
            registerFields.style.display = 'none';
            submitButton.textContent = 'Iniciar Sesi√≥n';
            toggleLink.textContent = '¬øNo tienes cuenta? Reg√≠strate';
        }
    }

    async function handleAuth() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const firstName = document.getElementById('authFirstName').value;
        const lastName = document.getElementById('authLastName').value;
        
        const payload = { email, password, role: currentAuthRole };
        if (isRegisterMode) {
            // Validaci√≥n simple de campos
            if (!firstName || !lastName) {
                showAlert('auth-message', 'Por favor, rellena tu nombre y apellido.', true);
                return;
            }
            Object.assign(payload, { firstName, lastName });
        }
        
        const endpoint = isRegisterMode ? '/auth/register' : '/auth/login';
        
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const result = await response.json();
            
            // Almacenar token y rol
            localStorage.setItem('token', result.token);
            localStorage.setItem('userRole', currentAuthRole);
            localStorage.setItem('userId', result.userId);
            localStorage.setItem('userFirstName', result.firstName || '');
            
            checkAuthentication();

        } catch (error) {
            showAlert('auth-message', error.message, true);
        }
    }

    // --- Funciones de Pantalla de Paciente ---

    function showScreen(screenId) {
        const screens = document.querySelectorAll('.app-screen');
        screens.forEach(screen => {
            screen.style.display = 'none';
        });
        document.getElementById(`${screenId}-screen`).style.display = 'block';

        const navButtons = document.querySelectorAll('.nav-bar button');
        navButtons.forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`nav-${screenId}`).classList.add('active');

        // L√≥gica de carga espec√≠fica para cada pantalla
        if (screenId === 'goals') {
            loadPatientGoals();
        }
        if (screenId === 'dashboard') {
            loadPatientDashboard();
        }
    }

    async function loadPatientDashboard() {
        // Cargar check-ins para el gr√°fico
        try {
            const response = await fetch(`${API_BASE_URL}/patient/checkins`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const checkins = await response.json();
            patientCheckinsCache = checkins;
            renderMoodChart(checkins);

        } catch (error) {
            document.getElementById('chart-message').textContent = `Error al cargar historial: ${error.message}`;
            console.error("Error al cargar dashboard:", error);
        }
    }
    
    /** Dibuja el gr√°fico de √°nimo usando Chart.js */
    function renderMoodChart(checkins) {
        const messageElement = document.getElementById('chart-message');
        if (checkins.length < 2) {
            messageElement.textContent = "Necesitas al menos 2 check-ins para generar un gr√°fico de progreso.";
            messageElement.style.display = 'block';
            if (window.moodChartInstance) {
                window.moodChartInstance.destroy();
                document.getElementById('moodChart').style.display = 'none';
            }
            return;
        }

        document.getElementById('moodChart').style.display = 'block';
        messageElement.style.display = 'none';

        // Ordenar check-ins por fecha
        checkins.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Limitar a los √∫ltimos 10 check-ins para una mejor visualizaci√≥n en m√≥vil
        const recentCheckins = checkins.slice(-10); 

        const dates = recentCheckins.map(c => new Date(c.date).toLocaleDateString());
        const scores = recentCheckins.map(c => c.moodScore);

        const ctx = document.getElementById('moodChart').getContext('2d');

        // Destruir la instancia anterior si existe
        if (window.moodChartInstance) {
            window.moodChartInstance.destroy();
        }

        window.moodChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Puntuaci√≥n de √Ånimo (1-5)',
                    data: scores,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    fill: true,
                    tension: 0.2, 
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 1,
                        max: 5,
                        ticks: {
                            stepSize: 1
                        },
                        title: {
                            display: true,
                            text: '√Ånimo (1=Mal, 5=Genial)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Fecha'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    async function submitCheckin() {
        const moodScore = document.getElementById('moodScore').value;
        const notes = document.getElementById('checkinNotes').value;
        
        try {
            const response = await fetch(`${API_BASE_URL}/patient/checkin`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ moodScore: parseInt(moodScore), notes })
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const result = await response.json();
            showAlert('checkin-message', 'Check-in registrado con √©xito!', false);
            document.getElementById('checkin-form').reset();
            document.getElementById('moodValue').innerText = '3';
            
            // Recargar dashboard para actualizar el gr√°fico
            setTimeout(() => {
                showScreen('dashboard');
            }, 1500);

        } catch (error) {
            showAlert('checkin-message', error.message, true);
        }
    }

    async function loadPatientGoals() {
        const goalsList = document.getElementById('goals-list');
        goalsList.innerHTML = 'Cargando metas...';
        
        try {
            const userId = localStorage.getItem('userId');
            if (!userId) throw new Error("ID de paciente no encontrado.");

            const response = await fetch(`${API_BASE_URL}/patient/goals/${userId}`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const goals = await response.json();
            
            patientGoalsCache = goals; // GUARDAR EN CACH√â
            document.getElementById('patientGoalFilter').value = 'ALL'; // Resetear filtro al cargar

            filterPatientGoals(); // LLAMAR AL FILTRO para renderizar
        } catch (error) {
            goalsList.innerHTML = `<p style="color: var(--secondary-color);">Error al cargar metas: ${error.message}</p>`;
        }
    }
    
    /** Filtra y renderiza las metas desde la cach√© con la barra de progreso. */
    function filterPatientGoals() {
        const filterValue = document.getElementById('patientGoalFilter').value;
        const goalsList = document.getElementById('goals-list');
        
        // 1. Aplicar filtro
        const filteredGoals = patientGoalsCache.filter(goal => {
            if (filterValue === 'ALL') {
                return true;
            }
            return goal.status === filterValue;
        });

        if (filteredGoals.length === 0) {
            goalsList.innerHTML = `<p>No tienes metas con el estado "${filterValue.replace('_', ' ')}".</p>`;
            return;
        }

        // 2. Renderizar lista con barra de progreso
        const statusClass = (status) => `status-badge status-${status}`;

        goalsList.innerHTML = filteredGoals.map(g => `
            <div class="goal-card status-${g.status}">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>${g.title}</strong>
                    <span class="${statusClass(g.status)}">${g.status.replace('_', ' ')}</span>
                </div>
                <p style="margin: 5px 0 10px 0;">${g.description || 'Sin descripci√≥n.'}</p>
                
                <div class="progress-bar-container">
                    <div class="progress-bar"></div> 
                </div>
                <small style="display: block; text-align: right; margin-top: 5px;">
                    L√≠mite: ${new Date(g.dueDate).toLocaleDateString()}
                </small>
                ${g.metric && g.target ? `<p style="margin: 5px 0 0 0;"><small>Objetivo: ${g.target} ${g.metric}</small></p>` : ''}
            </div>
        `).join('');
    }

    function checkAuthentication() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('userRole');
        const firstName = localStorage.getItem('userFirstName');
        
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('patientAppInterface').style.display = 'none';

        if (token) {
            if (role === 'PATIENT') {
                document.getElementById('patientAppInterface').style.display = 'block';
                document.getElementById('patientHeaderGreeting').textContent = `Hola, ${firstName || 'Paciente'}!`;
                showScreen('dashboard'); 

            } else if (role === 'THERAPIST') {
                window.location.href = 'therapist.html'; 
                
            } else {
                 logoutUser();
            }

        } else {
            document.getElementById('authScreen').style.display = 'block';
            showAuthRole('PATIENT'); 
        }
    }
    
    window.onload = checkAuthentication;
</script>
</body>
</html>